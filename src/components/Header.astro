---
import Navigation from "./Navigation";
import Logo from "./Logo.astro";
import { siteConfig, type HeaderLayout, type CTAShape, type NavItem } from "../config/site";
import type { ComponentConfig } from "../utils/recipe-context";

// Check if we're in showcase mode (showcaseConfig is set by ShowcaseLayout)
const showcaseConfig = (Astro.locals as any).showcaseConfig as ComponentConfig | undefined;

// Use showcase config if available, otherwise fall back to siteConfig
const headerLayout = (showcaseConfig?.header?.layout || siteConfig.header?.layout || 'standard') as HeaderLayout;
const ctaShape = (showcaseConfig?.header?.ctaShape || siteConfig.header?.ctaShape || 'rounded') as CTAShape;
const ctaShapeClass = ctaShape === 'pill' ? 'cta-pill' : 'cta-rounded';

// Get nav config - use showcase config if available, otherwise siteConfig
const navItems = (showcaseConfig?.nav?.items || siteConfig.nav.items) as NavItem[];
const navCta = showcaseConfig?.nav?.cta || siteConfig.nav.cta;
---

<header class="header glass" id="main-header" data-layout={headerLayout}>
  <div class="container header-content" data-layout={headerLayout}>
    <a href="/" class="logo">
      <Logo width={80} height={20} />
    </a>
    <div class="nav-wrapper">
      <Navigation
        client:load
        navItems={navItems}
        navCta={navCta}
        headerLayout={headerLayout}
        ctaShape={ctaShape}
      />
    </div>
    {/* CTA button as separate element for centered layout - placed in third grid column */}
    {headerLayout === 'centered' && navCta && (
      <a class={`header-cta NavigationCTAButton ${ctaShapeClass}`} href={navCta.href}>
        {navCta.label}
      </a>
    )}
  </div>
</header>

<script>
  document.addEventListener("astro:page-load", () => {
    let lastScrollY = window.scrollY;
    const header = document.getElementById("main-header");

    if (!header) return;

    const handleScroll = () => {
      const currentScrollY = window.scrollY;

      if (currentScrollY > lastScrollY && currentScrollY > 50) {
        header.classList.add("header-hidden");
        document.documentElement.classList.add("header-hidden");
      } else {
        header.classList.remove("header-hidden");
        document.documentElement.classList.remove("header-hidden");
      }

      lastScrollY = currentScrollY;
    };

    window.addEventListener("scroll", handleScroll);

    // Detect when sub-nav is stuck at top
    const subNav = document.querySelector(".sub-nav");
    const subNavContainer = document.querySelector(".sub-nav-container");
    if (subNav) {
      const observer = new IntersectionObserver(
        ([entry]) => {
          if (!entry.isIntersecting) {
            document.documentElement.classList.add("sub-nav-stuck");
          } else {
            document.documentElement.classList.remove("sub-nav-stuck");
          }
        },
        {
          rootMargin: "-1px 0px 0px 0px",
          threshold: 1,
        }
      );

      observer.observe(subNavContainer || subNav);
    }

    // Handle sub-nav horizontal scroll fade indicators
    if (subNav && subNavContainer) {
      const updateScrollFades = () => {
        const scrollLeft = subNav.scrollLeft;
        const scrollWidth = subNav.scrollWidth;
        const clientWidth = subNav.clientWidth;
        const threshold = 5;

        if (scrollLeft > threshold) {
          subNavContainer.classList.add("can-scroll-left");
        } else {
          subNavContainer.classList.remove("can-scroll-left");
        }

        if (scrollLeft + clientWidth < scrollWidth - threshold) {
          subNavContainer.classList.add("can-scroll-right");
        } else {
          subNavContainer.classList.remove("can-scroll-right");
        }
      };

      // Scroll active item into view on page load
      const activeItem = subNav.querySelector("a.active");
      if (activeItem) {
        setTimeout(() => {
          const navRect = subNav.getBoundingClientRect();
          const itemRect = activeItem.getBoundingClientRect();

          const itemCenter = itemRect.left + itemRect.width / 2;
          const navCenter = navRect.left + navRect.width / 2;
          const scrollOffset = itemCenter - navCenter;

          subNav.scrollBy({
            left: scrollOffset,
            behavior: "smooth"
          });

          setTimeout(updateScrollFades, 300);
        }, 0);
      }

      updateScrollFades();
      subNav.addEventListener("scroll", updateScrollFades);
      window.addEventListener("resize", updateScrollFades);
    }
  });
</script>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 100;
    height: var(--header-height);
    display: flex;
    align-items: center;
    background: var(--header-bg, var(--bg-light));
    border-bottom: 1px solid var(--header-border, transparent);
    backdrop-filter: blur(10px);
    transition: transform 0.3s ease-in-out;
  }

  :global(body.mobile-menu-open) .header {
    z-index: 10000;
  }

  .header-hidden {
    transform: translateY(-100%);
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }

  /* Centered layout: logo left, nav center, CTA right */
  .header-content[data-layout="centered"] {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 2rem;
    align-items: center;
  }

  .header-content[data-layout="centered"] .logo {
    justify-self: start;
  }

  .header-content[data-layout="centered"] .nav-wrapper {
    justify-self: center;
  }

  .header-content[data-layout="centered"] .header-cta {
    justify-self: end;
  }

  /* Header CTA styling - matches NavigationCTAButton */
  .header-cta {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .header-cta.cta-pill {
    border-radius: 9999px;
  }

  .logo {
    font-weight: 700;
    font-size: 1.5rem;
    color: var(--text-primary);
    letter-spacing: -0.03em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .logo-text {
    background: linear-gradient(
      90deg,
      var(--text-primary),
      var(--text-secondary)
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .nav-wrapper {
    display: block;
  }

  /* Navigation link colors from recipe */
  :global(.NavigationMenuLink),
  :global(.NavigationMenuTrigger) {
    color: var(--header-text, var(--text-secondary)) !important;
  }

  :global(.NavigationMenuLink:hover),
  :global(.NavigationMenuTrigger:hover) {
    color: var(--text-primary) !important;
  }

  /* CTA button styling from recipe */
  :global(.NavigationCTAButton) {
    background: var(--header-cta-bg) !important;
    color: var(--header-cta-text) !important;
  }

  :global(.NavigationCTAButton:hover) {
    background: var(--header-cta-hover-bg) !important;
    color: var(--header-cta-text) !important;
  }

  @media (min-width: 768px) {
    /* Desktop specific styles if needed */
  }
</style>
